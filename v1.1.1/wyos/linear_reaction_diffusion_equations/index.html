<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Linear Reaction-Diffusion Equations · FiniteVolumeMethod.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://DanielVandH.github.io/FiniteVolumeMethod.jl/wyos/linear_reaction_diffusion_equations/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">FiniteVolumeMethod.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><a class="tocitem" href="../../interface/">Interface</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/overview/">Section Overview</a></li><li><a class="tocitem" href="../../tutorials/diffusion_equation_on_a_square_plate/">Diffusion Equation on a Square Plate</a></li><li><a class="tocitem" href="../../tutorials/diffusion_equation_in_a_wedge_with_mixed_boundary_conditions/">Diffusion Equation in a Wedge with Mixed Boundary Conditions</a></li><li><a class="tocitem" href="../../tutorials/reaction_diffusion_equation_with_a_time_dependent_dirichlet_boundary_condition_on_a_disk/">Reaction-Diffusion Equation with a Time-dependent Dirichlet Boundary Condition on a Disk</a></li><li><a class="tocitem" href="../../tutorials/porous_medium_equation/">Porous-Medium Equation</a></li><li><a class="tocitem" href="../../tutorials/porous_fisher_equation_and_travelling_waves/">Porous-Fisher Equation and Travelling Waves</a></li><li><a class="tocitem" href="../../tutorials/piecewise_linear_and_natural_neighbour_interpolation_for_an_advection_diffusion_equation/">Piecewise Linear and Natural Neighbour Interpolation for an Advection-Diffusion Equation</a></li><li><a class="tocitem" href="../../tutorials/helmholtz_equation_with_inhomogeneous_boundary_conditions/">Helmholtz Equation with Inhomogeneous Boundary Conditions</a></li><li><a class="tocitem" href="../../tutorials/laplaces_equation_with_internal_dirichlet_conditions/">Laplace&#39;s Equation with Internal Dirichlet Conditions</a></li><li><a class="tocitem" href="../../tutorials/equilibrium_temperature_distribution_with_mixed_boundary_conditions_and_using_ensembleproblems/">Equilibrium Temperature Distribution with Mixed Boundary Conditions and using EnsembleProblems</a></li><li><a class="tocitem" href="../../tutorials/reaction_diffusion_brusselator_system_of_pdes/">A Reaction-Diffusion Brusselator System of PDEs</a></li><li><a class="tocitem" href="../../tutorials/gray_scott_model_turing_patterns_from_a_coupled_reaction_diffusion_system/">Gray-Scott Model: Turing Patterns from a Coupled Reaction-Diffusion System</a></li><li><a class="tocitem" href="../../tutorials/diffusion_equation_on_an_annulus/">Diffusion Equation on an Annulus</a></li><li><a class="tocitem" href="../../tutorials/mean_exit_time/">Mean Exit Time</a></li><li><a class="tocitem" href="../../tutorials/solving_mazes_with_laplaces_equation/">Solving Mazes with Laplace&#39;s Equation</a></li><li><a class="tocitem" href="../../tutorials/keller_segel_chemotaxis/">Keller-Segel Model of Chemotaxis</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Solvers for Specific Problems, and Writing Your Own</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../overview/">Section Overview</a></li><li><a class="tocitem" href="../diffusion_equations/">Diffusion Equations</a></li><li><a class="tocitem" href="../mean_exit_time/">Mean Exit Time Problems</a></li><li class="is-active"><a class="tocitem" href>Linear Reaction-Diffusion Equations</a><ul class="internal"><li><a class="tocitem" href="#Mathematical-Details"><span>Mathematical Details</span></a></li><li><a class="tocitem" href="#Implementation"><span>Implementation</span></a></li><li><a class="tocitem" href="#Using-the-Provided-Template"><span>Using the Provided Template</span></a></li><li><a class="tocitem" href="#Just-the-code"><span>Just the code</span></a></li></ul></li><li><a class="tocitem" href="../poissons_equation/">Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../laplaces_equation/">Laplace&#39;s Equation</a></li></ul></li><li><a class="tocitem" href="../../math/">Mathematical and Implementation Details</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Solvers for Specific Problems, and Writing Your Own</a></li><li class="is-active"><a href>Linear Reaction-Diffusion Equations</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Linear Reaction-Diffusion Equations</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/DanielVandH/FiniteVolumeMethod.jl/tree/main/docs/src/literate_wyos/linear_reaction_diffusion_equations.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Linear-Reaction-Diffusion-Equations"><a class="docs-heading-anchor" href="#Linear-Reaction-Diffusion-Equations">Linear Reaction-Diffusion Equations</a><a id="Linear-Reaction-Diffusion-Equations-1"></a><a class="docs-heading-anchor-permalink" href="#Linear-Reaction-Diffusion-Equations" title="Permalink"></a></h1><ul><li><a href="#Linear-Reaction-Diffusion-Equations">Linear Reaction-Diffusion Equations</a></li><li class="no-marker"><ul><li><a href="#Mathematical-Details">Mathematical Details</a></li><li><a href="#Implementation">Implementation</a></li><li><a href="#Using-the-Provided-Template">Using the Provided Template</a></li><li><a href="#Just-the-code">Just the code</a></li></ul></li></ul><p>Next, we write a specialised solver for solving linear reaction-diffusion equations. What we produce in this section can also be accessed in <code>FiniteVolumeMethod.LinearReactionDiffusionEquation</code>.</p><h2 id="Mathematical-Details"><a class="docs-heading-anchor" href="#Mathematical-Details">Mathematical Details</a><a id="Mathematical-Details-1"></a><a class="docs-heading-anchor-permalink" href="#Mathematical-Details" title="Permalink"></a></h2><p>To start, let&#39;s give the mathematical details. The problems we will be solving take the form</p><p class="math-container">\[\pdv{u}{t} = \div\left[D(\vb x)\grad u\right] + f(\vb x)u.\]</p><p>We want to turn this into an equation of the form <span>$\mathrm d\vb u/\mathrm dt = \vb A\vb u + \vb b$</span> as usual. This takes the same form as our <a href="../diffusion_equations/">diffusion equation example</a>, except with the extra <span>$f(\vb x)u$</span> term, which just adds an exta <span>$f(\vb x)$</span> term to the diagonal of <span>$\vb A$</span>. See the previois sections for further mathematical details.</p><h2 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h2><p>Let us now implement the solver. For constructing <span>$\vb A$</span>, we can use <code>FiniteVolumeMethod.triangle_contributions!</code> as in the previous sections, but we will need an extra function to add <span>$f(\vb x)$</span> to the appropriate diagonals. We can also reuse <code>apply_dirichlet_conditions!</code>, <code>apply_dudt_conditions</code>, and <code>boundary_edge_contributions!</code> from the diffusion equation example. Here is our implementation.</p><pre><code class="language-julia hljs">using FiniteVolumeMethod, SparseArrays, OrdinaryDiffEq, LinearAlgebra
const FVM = FiniteVolumeMethod
function linear_source_contributions!(A, mesh, conditions, source_function, source_parameters)
    for i in each_solid_vertex(mesh.triangulation)
        if !FVM.has_condition(conditions, i)
            x, y = get_point(mesh, i)
            A[i, i] += source_function(x, y, source_parameters)
        end
    end
end
function linear_reaction_diffusion_equation(mesh::FVMGeometry,
    BCs::BoundaryConditions,
    ICs::InternalConditions=InternalConditions();
    diffusion_function,
    diffusion_parameters=nothing,
    source_function,
    source_parameters=nothing,
    initial_condition,
    initial_time=0.0,
    final_time)
    conditions = Conditions(mesh, BCs, ICs)
    n = DelaunayTriangulation.num_solid_vertices(mesh.triangulation)
    Afull = zeros(n + 1, n + 1)
    A = @views Afull[begin:end-1, begin:end-1]
    b = @views Afull[begin:end-1, end]
    _ic = vcat(initial_condition, 1)
    FVM.triangle_contributions!(A, mesh, conditions, diffusion_function, diffusion_parameters)
    FVM.boundary_edge_contributions!(A, b, mesh, conditions, diffusion_function, diffusion_parameters)
    linear_source_contributions!(A, mesh, conditions, source_function, source_parameters)
    FVM.apply_dudt_conditions!(b, mesh, conditions)
    FVM.apply_dirichlet_conditions!(_ic, mesh, conditions)
    Af = sparse(Afull)
    prob = ODEProblem(MatrixOperator(Af), _ic, (initial_time, final_time))
    return prob
end</code></pre><pre><code class="nohighlight hljs">linear_reaction_diffusion_equation (generic function with 2 methods)</code></pre><p>If you go and look back at the <code>diffusion_equation</code> function from the <a href="../diffusion_equations/">diffusion equation example</a>, you will see that this is essentially the same function except we now have <code>linear_source_contributions!</code> and <code>source_function</code> and <code>source_parameters</code> arguments.</p><p>Let&#39;s now test this function. We consider the problem</p><p class="math-container">\[\pdv{T}{t} = \div\left[10^{-3}x^2y\grad T\right] + (x-1)(y-1)T, \quad \vb x \in [0,1]^2,\]</p><p>with <span>$\grad T \vdot\vu n = 1$</span> on the boundary.</p><pre><code class="language-julia hljs">using DelaunayTriangulation
tri = triangulate_rectangle(0, 1, 0, 1, 150, 150, single_boundary=true)
mesh = FVMGeometry(tri)
BCs = BoundaryConditions(mesh, (x, y, t, u, p) -&gt; one(x), Neumann)
diffusion_function = (x, y, p) -&gt; p.D * x^2 * y
diffusion_parameters = (D=1e-3,)
source_function = (x, y, p) -&gt; (x - 1) * (y - 1)
initial_condition = [x^2 + y^2 for (x, y) in each_point(tri)]
final_time = 8.0
prob = linear_reaction_diffusion_equation(mesh, BCs;
    diffusion_function, diffusion_parameters,
    source_function, initial_condition, final_time)</code></pre><pre><code class="nohighlight hljs">ODEProblem with uType Vector{Float64} and tType Float64. In-place: true
timespan: (0.0, 8.0)
u0: 22501-element Vector{Float64}:
 0.0
 4.504301608035674e-5
 0.00018017206432142696
 0.00040538714472321063
 0.0007206882572857079
 ⋮
 1.9601369307688843
 1.9733345344804287
 1.986622224224134
 2.0
 1.0</code></pre><pre><code class="language-julia hljs">using Sundials
sol = solve(prob, CVODE_BDF(linear_solver=:GMRES); saveat=2)</code></pre><pre><code class="nohighlight hljs">retcode: Success
Interpolation: 1st order linear
t: 5-element Vector{Float64}:
 0.0
 2.0
 4.0
 6.0
 8.0
u: 5-element Vector{Vector{Float64}}:
 [0.0, 4.504301608035674e-5, 0.00018017206432142696, 0.00040538714472321063, 0.0007206882572857079, 0.0011260754020089186, 0.0016215485788928425, 0.0022071077879374803, 0.0028827530291428314, 0.0036484843025088956  …  1.8955002026935723, 1.9082473762443133, 1.921084635827215, 1.9340119814422772, 1.9470294130895003, 1.9601369307688843, 1.9733345344804287, 1.986622224224134, 2.0, 1.0]
 [5.52716147191767e-10, 0.00033202071408202104, 0.001310140685137398, 0.002907992511210769, 0.005099927167281375, 0.007860998640123835, 0.011166947859617282, 0.014994186959034747, 0.019319783858113036, 0.024121447162812164  …  1.857896300391867, 1.8669544450900437, 1.8759244722984534, 1.884528730962924, 1.8927583990518235, 1.9008413452702824, 1.9084028870615026, 1.9156193227868221, 1.9221062046350286, 1.0]
 [7.870049813424153e-9, 0.00239092147887007, 0.00931146890308417, 0.02039815106135701, 0.035306625157419266, 0.053710878895533026, 0.0753024298375472, 0.09978955577827824, 0.1268965550360856, 0.15636303559215572  …  1.8504779433221192, 1.8582219226333596, 1.8660722866933632, 1.8736537551899137, 1.8806969833137446, 1.8881550315775186, 1.8950935404892248, 1.9016316807910907, 1.9088467115428092, 1.0]
 [8.333595175519436e-8, 0.016997517920280692, 0.065352787033468, 0.14133757251976914, 0.24151241806279378, 0.36270840869389104, 0.5020098139940017, 0.6567377163963104, 0.824434573299621, 1.0028496641991593  …  1.8563820911117714, 1.8631395312196728, 1.869946014570781, 1.8767665953695387, 1.8829820658335772, 1.8904507091419824, 1.896510120608713, 1.9036592580392455, 1.9105309742082484, 1.0]
 [7.871236404836896e-7, 0.12056861985382407, 0.4576775099028521, 0.9772248996008429, 1.6485909454406105, 2.444347087267379, 3.339985650693463, 4.3136697132174175, 5.346001839352283, 6.419810380000953  …  1.870086927761359, 1.876313132360229, 1.8824264689960384, 1.8887230748064165, 1.8948706021128898, 1.9014030996603855, 1.9076743375079266, 1.9146996044875533, 1.921250692046168, 1.0]</code></pre><pre><code class="language-julia hljs">using CairoMakie
fig = Figure(fontsize=38)
for j in eachindex(sol)
    ax = Axis(fig[1, j], width=600, height=600,
        xlabel=&quot;x&quot;, ylabel=&quot;y&quot;,
        title=&quot;t = $(sol.t[j])&quot;)
    tricontourf!(ax, tri, sol.u[j], levels=0:0.1:1, extendlow=:auto, extendhigh=:auto, colormap=:turbo)
    tightlimits!(ax)
end
resize_to_layout!(fig)
fig</code></pre><p><img src="../linear_reaction_diffusion_equations-11.png" alt/></p><p>Here is how we could convert this into an <code>FVMProblem</code>. Note that the Neumann boundary conditions are expressed as <span>$\grad T\vdot\vu n = 1$</span> above, but for <code>FVMProblem</code> we need them in the form <span>$\vb q\vdot\vu n = \ldots$</span>. For this problem, <span>$\vb q=-D\grad T$</span>, which gives <span>$\vb q\vdot\vu n = -D$</span>.</p><pre><code class="language-julia hljs">_BCs = BoundaryConditions(mesh, (x, y, t, u, p) -&gt; -p.D(x, y, p.Dp), Neumann;
    parameters=(D=diffusion_function, Dp=diffusion_parameters))
fvm_prob = FVMProblem(
    mesh,
    _BCs;
    diffusion_function=let D=diffusion_function
        (x, y, t, u, p) -&gt; D(x, y, p)
    end,
    diffusion_parameters=diffusion_parameters,
    source_function=let S=source_function
        (x, y, t, u, p) -&gt; S(x, y, p) * u
    end,
    final_time=final_time,
    initial_condition=initial_condition
)
fvm_sol = solve(fvm_prob, CVODE_BDF(linear_solver=:GMRES), saveat=2.0)</code></pre><pre><code class="nohighlight hljs">retcode: Success
Interpolation: 1st order linear
t: 5-element Vector{Float64}:
 0.0
 2.0
 4.0
 6.0
 8.0
u: 5-element Vector{Vector{Float64}}:
 [0.0, 4.504301608035674e-5, 0.00018017206432142696, 0.00040538714472321063, 0.0007206882572857079, 0.0011260754020089186, 0.0016215485788928425, 0.0022071077879374803, 0.0028827530291428314, 0.0036484843025088956  …  1.882843115174992, 1.8955002026935723, 1.9082473762443133, 1.921084635827215, 1.9340119814422772, 1.9470294130895003, 1.9601369307688843, 1.9733345344804287, 1.986622224224134, 2.0]
 [5.527159522197993e-10, 0.00033202065747419795, 0.0013101404649735323, 0.002907992029615947, 0.005099926335027021, 0.007860997376214488, 0.011166946090891146, 0.014994184619777667, 0.019319780889685514, 0.024121443513289077  …  1.8483412443440257, 1.8578963183640198, 1.8669544935607576, 1.875924599543153, 1.8845287440440046, 1.8927584164243525, 1.9008413111548383, 1.908402964817432, 1.915619338162616, 1.922106436035809]
 [7.87001248828909e-9, 0.0023909150521509597, 0.009311444373109493, 0.02039809840570013, 0.03530653586685066, 0.053710745842223746, 0.07530224715196154, 0.09978931873428111, 0.1268962599438122, 0.15636267969821271  …  1.842868654374407, 1.8504775274036567, 1.8582219456507867, 1.86607128871784, 1.8736552390764944, 1.8806970604061661, 1.8881539534289395, 1.8950926833316355, 1.9016312526280714, 1.908845723176872]
 [8.333310693965402e-8, 0.016997151442489488, 0.06535140941115761, 0.1413346601687334, 0.2415075544256798, 0.3627012714662447, 0.5020001635366396, 0.6567253852401947, 0.824419456656008, 1.0028317113939482  …  1.8492212899243674, 1.8563779837597172, 1.8631445769625725, 1.8699385500205448, 1.8767718063420156, 1.88297703482452, 1.8904519300008489, 1.8965032413784213, 1.9036641980370916, 1.9105371961810371]
 [7.871829902419554e-7, 0.12057510312743423, 0.4577016212428087, 0.9772753278375627, 1.6486742607392675, 2.444468041589295, 3.340147444809675, 4.313874233478259, 5.346249867141459, 6.420101776549013  …  1.863774856874149, 1.8700733364248312, 1.8763465973207063, 1.8824077185972963, 1.8887503719956227, 1.8948555728549277, 1.9014118062800054, 1.907678433637668, 1.914707648498935, 1.921247490832573]</code></pre><h2 id="Using-the-Provided-Template"><a class="docs-heading-anchor" href="#Using-the-Provided-Template">Using the Provided Template</a><a id="Using-the-Provided-Template-1"></a><a class="docs-heading-anchor-permalink" href="#Using-the-Provided-Template" title="Permalink"></a></h2><p>The above code is implemented in <code>LinearReactionDiffusionEquation</code> in FiniteVolumeMethod.jl.</p><pre><code class="language-julia hljs">prob = LinearReactionDiffusionEquation(mesh, BCs;
    diffusion_function, diffusion_parameters,
    source_function,  initial_condition, final_time)
sol = solve(prob, CVODE_BDF(linear_solver=:GMRES); saveat=2)</code></pre><pre><code class="nohighlight hljs">retcode: Success
Interpolation: 1st order linear
t: 5-element Vector{Float64}:
 0.0
 2.0
 4.0
 6.0
 8.0
u: 5-element Vector{Vector{Float64}}:
 [0.0, 4.504301608035674e-5, 0.00018017206432142696, 0.00040538714472321063, 0.0007206882572857079, 0.0011260754020089186, 0.0016215485788928425, 0.0022071077879374803, 0.0028827530291428314, 0.0036484843025088956  …  1.8955002026935723, 1.9082473762443133, 1.921084635827215, 1.9340119814422772, 1.9470294130895003, 1.9601369307688843, 1.9733345344804287, 1.986622224224134, 2.0, 1.0]
 [5.52716147191767e-10, 0.00033202071408202104, 0.001310140685137398, 0.002907992511210769, 0.005099927167281375, 0.007860998640123835, 0.011166947859617282, 0.014994186959034747, 0.019319783858113036, 0.024121447162812164  …  1.857896300391867, 1.8669544450900437, 1.8759244722984534, 1.884528730962924, 1.8927583990518235, 1.9008413452702824, 1.9084028870615026, 1.9156193227868221, 1.9221062046350286, 1.0]
 [7.870049813424153e-9, 0.00239092147887007, 0.00931146890308417, 0.02039815106135701, 0.035306625157419266, 0.053710878895533026, 0.0753024298375472, 0.09978955577827824, 0.1268965550360856, 0.15636303559215572  …  1.8504779433221192, 1.8582219226333596, 1.8660722866933632, 1.8736537551899137, 1.8806969833137446, 1.8881550315775186, 1.8950935404892248, 1.9016316807910907, 1.9088467115428092, 1.0]
 [8.333595175519436e-8, 0.016997517920280692, 0.065352787033468, 0.14133757251976914, 0.24151241806279378, 0.36270840869389104, 0.5020098139940017, 0.6567377163963104, 0.824434573299621, 1.0028496641991593  …  1.8563820911117714, 1.8631395312196728, 1.869946014570781, 1.8767665953695387, 1.8829820658335772, 1.8904507091419824, 1.896510120608713, 1.9036592580392455, 1.9105309742082484, 1.0]
 [7.871236404836896e-7, 0.12056861985382407, 0.4576775099028521, 0.9772248996008429, 1.6485909454406105, 2.444347087267379, 3.339985650693463, 4.3136697132174175, 5.346001839352283, 6.419810380000953  …  1.870086927761359, 1.876313132360229, 1.8824264689960384, 1.8887230748064165, 1.8948706021128898, 1.9014030996603855, 1.9076743375079266, 1.9146996044875533, 1.921250692046168, 1.0]</code></pre><p>Here is a benchmark comparison of <code>LinearReactionDiffusionEquation</code> versus <code>FVMProblem</code>.</p><pre><code class="language-julia hljs">using BenchmarkTools
@btime solve($prob, $CVODE_BDF(linear_solver=:GMRES); saveat=$2);</code></pre><pre><code class="nohighlight hljs">  48.360 ms (1087 allocations: 1.58 MiB)</code></pre><pre><code class="language-julia hljs">@btime solve($fvm_prob, $CVODE_BDF(linear_solver=:GMRES); saveat=$2);</code></pre><pre><code class="nohighlight hljs">  163.686 ms (83267 allocations: 90.84 MiB)</code></pre><h2 id="Just-the-code"><a class="docs-heading-anchor" href="#Just-the-code">Just the code</a><a id="Just-the-code-1"></a><a class="docs-heading-anchor-permalink" href="#Just-the-code" title="Permalink"></a></h2><p>An uncommented version of this example is given below. You can view the source code for this file <a href="https://github.com/DanielVandH/FiniteVolumeMethod.jl/tree/main/docs/src/literate_wyos/linear_reaction_diffusion_equations.jl">here</a>.</p><pre><code class="language-julia hljs">using FiniteVolumeMethod, SparseArrays, OrdinaryDiffEq, LinearAlgebra
const FVM = FiniteVolumeMethod
function linear_source_contributions!(A, mesh, conditions, source_function, source_parameters)
    for i in each_solid_vertex(mesh.triangulation)
        if !FVM.has_condition(conditions, i)
            x, y = get_point(mesh, i)
            A[i, i] += source_function(x, y, source_parameters)
        end
    end
end
function linear_reaction_diffusion_equation(mesh::FVMGeometry,
    BCs::BoundaryConditions,
    ICs::InternalConditions=InternalConditions();
    diffusion_function,
    diffusion_parameters=nothing,
    source_function,
    source_parameters=nothing,
    initial_condition,
    initial_time=0.0,
    final_time)
    conditions = Conditions(mesh, BCs, ICs)
    n = DelaunayTriangulation.num_solid_vertices(mesh.triangulation)
    Afull = zeros(n + 1, n + 1)
    A = @views Afull[begin:end-1, begin:end-1]
    b = @views Afull[begin:end-1, end]
    _ic = vcat(initial_condition, 1)
    FVM.triangle_contributions!(A, mesh, conditions, diffusion_function, diffusion_parameters)
    FVM.boundary_edge_contributions!(A, b, mesh, conditions, diffusion_function, diffusion_parameters)
    linear_source_contributions!(A, mesh, conditions, source_function, source_parameters)
    FVM.apply_dudt_conditions!(b, mesh, conditions)
    FVM.apply_dirichlet_conditions!(_ic, mesh, conditions)
    Af = sparse(Afull)
    prob = ODEProblem(MatrixOperator(Af), _ic, (initial_time, final_time))
    return prob
end

using DelaunayTriangulation
tri = triangulate_rectangle(0, 1, 0, 1, 150, 150, single_boundary=true)
mesh = FVMGeometry(tri)
BCs = BoundaryConditions(mesh, (x, y, t, u, p) -&gt; one(x), Neumann)
diffusion_function = (x, y, p) -&gt; p.D * x^2 * y
diffusion_parameters = (D=1e-3,)
source_function = (x, y, p) -&gt; (x - 1) * (y - 1)
initial_condition = [x^2 + y^2 for (x, y) in each_point(tri)]
final_time = 8.0
prob = linear_reaction_diffusion_equation(mesh, BCs;
    diffusion_function, diffusion_parameters,
    source_function, initial_condition, final_time)

using Sundials
sol = solve(prob, CVODE_BDF(linear_solver=:GMRES); saveat=2)

using CairoMakie
fig = Figure(fontsize=38)
for j in eachindex(sol)
    ax = Axis(fig[1, j], width=600, height=600,
        xlabel=&quot;x&quot;, ylabel=&quot;y&quot;,
        title=&quot;t = $(sol.t[j])&quot;)
    tricontourf!(ax, tri, sol.u[j], levels=0:0.1:1, extendlow=:auto, extendhigh=:auto, colormap=:turbo)
    tightlimits!(ax)
end
resize_to_layout!(fig)
fig

_BCs = BoundaryConditions(mesh, (x, y, t, u, p) -&gt; -p.D(x, y, p.Dp), Neumann;
    parameters=(D=diffusion_function, Dp=diffusion_parameters))
fvm_prob = FVMProblem(
    mesh,
    _BCs;
    diffusion_function=let D=diffusion_function
        (x, y, t, u, p) -&gt; D(x, y, p)
    end,
    diffusion_parameters=diffusion_parameters,
    source_function=let S=source_function
        (x, y, t, u, p) -&gt; S(x, y, p) * u
    end,
    final_time=final_time,
    initial_condition=initial_condition
)
fvm_sol = solve(fvm_prob, CVODE_BDF(linear_solver=:GMRES), saveat=2.0)

prob = LinearReactionDiffusionEquation(mesh, BCs;
    diffusion_function, diffusion_parameters,
    source_function,  initial_condition, final_time)
sol = solve(prob, CVODE_BDF(linear_solver=:GMRES); saveat=2)</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../mean_exit_time/">« Mean Exit Time Problems</a><a class="docs-footer-nextpage" href="../poissons_equation/">Poisson&#39;s Equation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Saturday 16 September 2023 16:43">Saturday 16 September 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
